<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
</head>
<body>
  <div style="display: flex;">
    <div style="flex: 1;">
      <canvas id="canvas" width="540" height="540" style="border:1px solid #d3d3d3;">
    </div>

    <div style="flex: 2; margin-left: 3%; margin-right: 3%;">
      <h1 class="text-center">Instagraphic</h1>

      <form>
        <div class="mb-3">
          <label for="headline" class="form-label">Headline</label>
          <input type="text" class="form-control" id="headline" value="Pitt to host fall sports on campus without attendance restrictions">
        </div>

        <div class="mb-3">
          <label for="byline" class="form-label">Byline</label>
          <input type="text" class="form-control" id="byline" value="Stephen Thompson, Senior Staff Writer">
        </div>

        <div class="mb-3">
          <label for="storyText" class="form-label">Text</label>
          <textarea class="form-control" id="storyText">Pitt athletics is hoping to take a big step back towards pre-pandemic operations this fall. According to a report from the Pittsburgh Post-Gazette on Wednesday afternoon, Pitt plans on open on-campus venues to full capacity for fall sports this year, with some regulations for spectators still in place.</textarea>
        </div>

        <div class="mb-3">
          <label for="imageUrl" class="form-label">Image URL</label>
          <input type="text" class="form-control" id="imageUrl" value="https://pittnews.com/wp-content/uploads/2021/08/S_FB_JM_1.jpg">
        </div>

        <button type="submit" class="btn btn-primary" id="regenerate">Regenerate</button>
        <button class="btn btn-success" id="download">Download</button>
      </form>
    </div>
  </div>

  <script>
    function paintCanvas(headline, byline, storyText, imageurl) {
      var c = document.getElementById("canvas");
      c.width = 542;
      c.height = 542;

      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, c.width, c.height);

      const heightConstraints = {
        headlineRows: ctx.measureText(headline).width >= 190 ? 2 : 1,
      };

      // ** LOGO
      logo = new Image();
      logo.src = 'https://pittnews.com/wp-content/uploads/2018/07/mini-header1.png';
      logo.onload = function(){
        ctx.drawImage(logo, (540 - (480/2.8))/2, 0, 480/2.8, 132/2.8);
        // 480 x 132 ratio
      }

      // ** HEADLINE
      ctx.font = '24px Aleo';
      ctx.textAlign = 'center';
      if (heightConstraints.headlineRows === 1) {
        ctx.fillText(headline, 270, (132/2.8) + 25);
      } else if (heightConstraints.headlineRows === 2) {
        var splitHeadline = headline.split(' ');
        var headline1 = splitHeadline.slice(0, (splitHeadline.length / 2)).join(' ');
        ctx.fillText(headline1, 270, (132/2.8) + 25);

        var headline2 = splitHeadline.slice((splitHeadline.length / 2), splitHeadline.length).join(' ');
        ctx.fillText(headline2, 270, (132/2.8) + 49);
      }

      // ** BYLINE
      ctx.font = '16px Minion Pro';
      ctx.textAlign = 'center';
      const bylineHeight = heightConstraints.headlineRows === 2 ? 122 : 98;
      ctx.fillText(`By ${byline}`, 270, bylineHeight);

      // ** TEXT
      var startStoryText = (540 - (601/1.9) - 125 - 64) / 2;
      ctx.font = '14px Minion Pro';
      ctx.textAlign = 'start';

      if (ctx.measureText(storyText).width >= 465) {
        var storyTextLines = [[0, 0, 0]];
        var storyTextBySpaces = storyText.split(' ');
        var storyTextBySpacesWidths = storyTextBySpaces.map((t) => ctx.measureText(t).width);
        for(var i = 0; i < storyTextBySpacesWidths.length; i++) {
          var storyTextBySpaceWidth = storyTextBySpacesWidths[i];
          var currentStoryTextLine = storyTextLines[storyTextLines.length - 1];
          if (currentStoryTextLine[2] + storyTextBySpaceWidth <= 465) {
            currentStoryTextLine[1] = i;
            currentStoryTextLine[2] += storyTextBySpaceWidth;
          } else {
            storyTextLines.push([i - 1, i, storyTextBySpaceWidth]);
          }
        }

        var storyText1 = storyTextBySpaces.slice(storyTextLines[0][0], storyTextLines[0][1]).join(' ');
        if (storyTextLines.length === 2) {
          var storyText2 = storyTextBySpaces.slice(storyTextLines[1][0], storyTextLines[1][1] + 1).join(' ');
        } else if (storyTextLines.length === 3) {
          var storyText2 = storyTextBySpaces.slice(storyTextLines[1][0], storyTextLines[1][1]).join(' ');
          var storyText3 = storyTextBySpaces.slice(storyTextLines[2][0], storyTextLines[2][1] + 1).join(' ');
        } else if (storyTextLines.length === 4) {
          var storyText2 = storyTextBySpaces.slice(storyTextLines[1][0], storyTextLines[1][1]).join(' ');
          var storyText3 = storyTextBySpaces.slice(storyTextLines[2][0], storyTextLines[2][1]).join(' ');
          var storyText4 = storyTextBySpaces.slice(storyTextLines[3][0], storyTextLines[3][1] + 1).join(' ');
        } else {
          var storyText1 = storyText;
        }
       } else {
        var storyText1 = storyText;
       }

      ctx.fillText(storyText1, 20, startStoryText + 125 + 16);
      if (storyText2) ctx.fillText(storyText2, 20, startStoryText + 125 + 32);
      if (storyText3) ctx.fillText(storyText3, 20, startStoryText + 125 + 48);
      if (storyText4) ctx.fillText(storyText4, 20, startStoryText + 125 + 64);

      // ** IMAGE
      img = new Image();
      img.src = imageurl;
      img.onload = function(){
        ctx.drawImage(img, (540 - (900/1.9))/2, 230, 900/1.9, 601/1.9);
        // 900 x 601 ratio
      }
    }

    window.onload = function() {
      paintCanvas(
        'Pitt to host fall sports on campus without attendance restrictions',
        'Stephen Thompson, Senior Staff Writer',
        'Pitt athletics is hoping to take a big step back towards pre-pandemic operations this fall. According to a report from the Pittsburgh Post-Gazette on Wednesday afternoon, Pitt plans on open on-campus venues to full capacity for fall sports this year, with some regulations for spectators still in place.',
        'https://pittnews.com/wp-content/uploads/2021/08/S_FB_JM_1.jpg'
      );

      document.getElementById('regenerate').addEventListener('click', (event) => {
        event.preventDefault();
        paintCanvas(
          document.getElementById('headline').value,
          document.getElementById('byline').value,
          document.getElementById('storyText').value,
          document.getElementById('imageUrl').value,
        );
      });

      document.getElementById('download').addEventListener('click', (event) => {
        event.preventDefault();
        const c = document.getElementById("canvas");
        const img = c.toDataURL("image/png");
        document.write('<img src="'+img+'"/>');
      });
    };
  </script>
</body>
